<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>お口に指を入れるゲーム</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100vh;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    #startBtn, #retryBtn, #tweetBtn {
      font-size: 18px;
      padding: 10px;
      margin-right: 10px;
    }
    #retryBtn, #tweetBtn {
      display: none;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn">スタート</button>
    <button id="retryBtn">もう一度挑戦</button>
    <a id="tweetBtn" href="#" target="_blank">Xに投稿</a>
  </div>
  <canvas id="gameCanvas"></canvas>
  <audio id="bgm" src="bgm.mp3" loop></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");
    const tweetBtn = document.getElementById("tweetBtn");
    const bgm = document.getElementById("bgm");

    let isMouthOpen = false;
    let gameStarted = false;
    let gameOver = false;
    let fingerJump = false;
    let images = {};

    const loadImage = (src) => {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = src;
        img.onload = () => resolve(img);
      });
    };

    const loadImages = async () => {
      images.open = await loadImage("open.jpg");
      images.close = await loadImage("close.jpg");
      images.finger = await loadImage("finger.png");
    };

    const resizeCanvas = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let intervalId;

    const startGame = () => {
      gameStarted = true;
      gameOver = false;
      isMouthOpen = false;
      startBtn.style.display = "none";
      retryBtn.style.display = "none";
      tweetBtn.style.display = "none";
      bgm.currentTime = 0;
      bgm.play();

      intervalId = setInterval(() => {
        isMouthOpen = Math.random() < 0.5;
      }, 500);

      draw();
    };

    const endGame = () => {
      clearInterval(intervalId);
      gameOver = true;
      retryBtn.style.display = "inline-block";
      tweetBtn.style.display = "inline-block";
    };

    const draw = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const baseImg = isMouthOpen ? images.open : images.close;

      // フル画面幅で上にぴったり合わせて描画
      const imgW = canvas.width;
      const imgH = baseImg.height * (imgW / baseImg.width);
      ctx.drawImage(baseImg, 0, 0, imgW, imgH);

      // 指を同じ位置に重ねて描画
      const fingerW = canvas.width;
      const fingerH = images.finger.height * (fingerW / images.finger.width);
      const fingerY = fingerJump ? -20 : 0; // 上に少しジャンプ
      ctx.drawImage(images.finger, 0, fingerY, fingerW, fingerH);

      if (!gameOver) requestAnimationFrame(draw);
    };

    const checkInput = () => {
      if (!gameStarted || gameOver) return;

      fingerJump = true;
      setTimeout(() => {
        fingerJump = false;
      }, 100);

      if (!isMouthOpen) {
        endGame();
      }
    };

    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") checkInput();
    });
    document.addEventListener("touchstart", checkInput);

    startBtn.addEventListener("click", startGame);
    retryBtn.addEventListener("click", startGame);

    tweetBtn.addEventListener("click", () => {
      const tweetText = encodeURIComponent("お口に指を入れるゲームに挑戦したよ！#数寄屋橋れんげ");
      const tweetUrl = encodeURIComponent(location.href);
      tweetBtn.href = `https://twitter.com/intent/tweet?text=${tweetText}&url=${tweetUrl}`;
    });

    loadImages();
  </script>
</body>
</html>
